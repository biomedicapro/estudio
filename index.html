<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estudio Interactivo</title>
  <style>
    /* Reset y configuración base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      width: 100%;
      font-family: "Segoe UI", sans-serif;
      overflow: hidden;
    }
    body.light {
      background-color: #ffffff;
      color: #111;
    }
    body.dark {
      background-color: #111;
      color: #eee;
    }
    /* Contenedor principal de la aplicación */
    .app-container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    /* Vistas de selección de carpeta (Categoría, Asignatura, Tema) */
    .folder-view {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .folder-view h2 {
      margin-bottom: 15px;
    }
    .folder-list {
      list-style: none;
      padding: 0;
    }
    .folder-item {
      padding: 10px 15px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f5f5f5;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .folder-item:hover {
      background-color: #ddd;
    }
    .back-button {
      margin-bottom: 15px;
      padding: 8px 12px;
      border: none;
      background-color: #444;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Vista de Estudio – pantalla completa */
    .study-view {
      display: none;
      height: 100%;
      width: 100%;
      position: relative;
      background-color: inherit;
      color: inherit;
    }
    .study-view.active {
      display: block;
    }
    /* Panel Superior: Barra de Progreso */
    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 60px; /* dejar espacio para el panel derecho */
      height: 50px;
      background-color: rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      overflow-x: auto;
      padding: 0 10px;
    }
    .progress-item {
      width: 40px;
      height: 40px;
      margin: 0 5px;
      border-radius: 50%;
      background-color: gray;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }
    .progress-item.fácil { background-color: green; }
    .progress-item.medio { background-color: yellow; color: #000; }
    .progress-item.difícil { background-color: red; }
    /* Panel Derecho: Controles Interactivos */
    .control-panel {
      position: absolute;
      top: 50px;
      right: 0;
      width: 60px;
      bottom: 0;
      background-color: rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
    }
    .control-panel button {
      background: none;
      border: none;
      margin: 10px 0;
      cursor: pointer;
      font-size: 20px;
    }
    /* Área Central: Tarjeta */
    .card-area {
      position: absolute;
      top: 50px;
      left: 0;
      right: 60px;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .card {
      width: 100%;
      max-width: 600px;
      height: 80%;
      background-color: rgba(255,255,255,0.9);
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      overflow-y: auto;
      font-size: calc(16px + 0.5vw);
    }
    .card-face.back {
      transform: rotateY(180deg);
    }
    .card.flip {
      transform: rotateY(180deg);
    }
    /* Flechas de Navegación (dentro de la tarjeta) */
    .nav-arrows {
      position: absolute;
      bottom: 10px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
    }
    .nav-arrows button {
      background: rgba(0,0,0,0.5);
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
    }
    /* Opciones para preguntas tipo test */
    .options {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .option {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: pointer;
      background-color: #f5f5f5;
      transition: background-color 0.3s;
    }
    .option:hover {
      background-color: #ddd;
    }
    .option.correct {
      background-color: green;
      color: #fff;
    }
    .option.incorrect {
      background-color: red;
      color: #fff;
    }
  </style>
</head>
<body class="light">
  <div class="app-container">
    <!-- Vistas de Selección de Carpeta -->
    <div id="folderView" class="folder-view active">
      <h2>Selecciona Categoría</h2>
      <ul id="categoryList" class="folder-list"></ul>
    </div>
    <div id="subjectView" class="folder-view" style="display:none;">
      <button class="back-button" onclick="showFolderView()">&#8592; Regresar</button>
      <h2>Selecciona Asignatura</h2>
      <ul id="subjectList" class="folder-list"></ul>
    </div>
    <div id="topicView" class="folder-view" style="display:none;">
      <button class="back-button" onclick="showSubjectView()">&#8592; Regresar</button>
      <h2>Selecciona Tema</h2>
      <ul id="topicList" class="folder-list"></ul>
    </div>
    <!-- Vista de Estudio -->
    <div id="studyView" class="study-view">
      <!-- Panel Superior: Barra de Progreso -->
      <div class="progress-bar" id="progressBar"></div>
      <!-- Panel Derecho: Controles Interactivos -->
      <div class="control-panel">
        <button onclick="exitStudy()" title="Regresar">&#x21A9;</button>
        <button onclick="toggleDarkMode()" title="Modo Claro/Oscuro">&#9788;</button>
        <button onclick="setDifficulty('fácil')" title="Fácil">F</button>
        <button onclick="setDifficulty('medio')" title="Medio">M</button>
        <button onclick="setDifficulty('difícil')" title="Difícil">D</button>
      </div>
      <!-- Área Central: Tarjeta -->
      <div class="card-area">
        <div class="card" id="card">
          <div class="card-face front" id="cardFront">
            <div id="cardContent"></div>
            <div id="optionsContainer" class="options"></div>
          </div>
          <div class="card-face back" id="cardBack">
            <div id="cardAnswer"></div>
            <div id="cardExplanation" style="margin-top:20px; font-size:0.9em;"></div>
          </div>
          <div class="nav-arrows">
            <button onclick="prevQuestion()">&#8592;</button>
            <button onclick="flipCard()">&#8635;</button>
            <button onclick="nextQuestion()">&#8594;</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    /* VARIABLES GLOBALES */
    let sheetData = null;  // Estructura completa (carpetas) desde el backend
    let deck = [];         // Mazo de preguntas del tema seleccionado
    let currentQuestionIndex = 0;
    let darkMode = false;
    // Variables para la selección de carpeta
    let selectedCategory = null;
    let selectedSubject = null;
    let selectedTopic = null;
    // URL de despliegue del Apps Script (REEMPLAZAR "YOUR_SCRIPT_URL" por el URL real)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwWB__WemfDPevnrxDEnbAijBfNfq9f25Yoe132fflEcwFdGQbs8zNTpPeTezp8P9U/exec";

    /* CARGA DE ESTRUCTURA DE CARPETAS */
    function loadFolderStructure() {
      fetch(`${SCRIPT_URL}?action=getStructure`)
      .then(res => res.json())
      .then(result => {
        if(result.status === "success") {
          sheetData = result.data;
          renderCategories();
        } else {
          alert("Error al cargar la estructura: " + result.message);
        }
      })
      .catch(err => console.error(err));
    }
    function renderCategories() {
      const categoryList = document.getElementById("categoryList");
      categoryList.innerHTML = "";
      sheetData.categories.forEach(cat => {
        const li = document.createElement("li");
        li.className = "folder-item";
        li.textContent = cat.name;
        li.onclick = () => {
          selectedCategory = cat;
          renderSubjects(cat);
          showSubjectView();
        };
        categoryList.appendChild(li);
      });
    }
    function renderSubjects(category) {
      const subjectList = document.getElementById("subjectList");
      subjectList.innerHTML = "";
      category.subjects.forEach(sub => {
        const li = document.createElement("li");
        li.className = "folder-item";
        li.textContent = sub.name;
        li.onclick = () => {
          selectedSubject = sub;
          renderTopics(category, sub);
          showTopicView();
        };
        subjectList.appendChild(li);
      });
    }
    function renderTopics(category, subject) {
      const topicList = document.getElementById("topicList");
      topicList.innerHTML = "";
      subject.topics.forEach(top => {
        const li = document.createElement("li");
        li.className = "folder-item";
        li.textContent = top.name;
        li.onclick = () => {
          selectedTopic = top;
          loadDeck(category.name, subject.name, top.name);
          showStudyView();
        };
        topicList.appendChild(li);
      });
    }
    /* CAMBIOS DE VISTA */
    function showFolderView() {
      document.getElementById("folderView").style.display = "block";
      document.getElementById("subjectView").style.display = "none";
      document.getElementById("topicView").style.display = "none";
      document.getElementById("studyView").classList.remove("active");
    }
    function showSubjectView() {
      document.getElementById("folderView").style.display = "none";
      document.getElementById("subjectView").style.display = "block";
      document.getElementById("topicView").style.display = "none";
      document.getElementById("studyView").classList.remove("active");
    }
    function showTopicView() {
      document.getElementById("folderView").style.display = "none";
      document.getElementById("subjectView").style.display = "none";
      document.getElementById("topicView").style.display = "block";
      document.getElementById("studyView").classList.remove("active");
    }
    function showStudyView() {
      document.getElementById("folderView").style.display = "none";
      document.getElementById("subjectView").style.display = "none";
      document.getElementById("topicView").style.display = "none";
      document.getElementById("studyView").classList.add("active");
      currentQuestionIndex = 0;
      renderProgressBar();
      displayQuestion();
    }
    /* CARGA DEL MAZO (DECK) */
    function loadDeck(category, subject, topic) {
      fetch(`${SCRIPT_URL}?action=loadDeck&category=${encodeURIComponent(category)}&subject=${encodeURIComponent(subject)}&topic=${encodeURIComponent(topic)}`)
      .then(res => res.json())
      .then(result => {
        if(result.status === "success") {
          deck = result.data.deck;
          // Retomar la primera pregunta sin dificultad asignada
          const idx = deck.findIndex(q => !q.dificultad || q.dificultad.trim() === "");
          currentQuestionIndex = idx >= 0 ? idx : 0;
          renderProgressBar();
          displayQuestion();
        } else {
          alert("Error al cargar el mazo: " + result.message);
        }
      })
      .catch(err => console.error(err));
    }
    /* BARRA DE PROGRESO */
    function renderProgressBar() {
      const progressBar = document.getElementById("progressBar");
      progressBar.innerHTML = "";
      deck.forEach((q, idx) => {
        const div = document.createElement("div");
        div.className = "progress-item";
        if(q.dificultad) {
          const dif = q.dificultad.toLowerCase();
          if(dif === "fácil") div.classList.add("fácil");
          else if(dif === "medio") div.classList.add("medio");
          else if(dif === "difícil") div.classList.add("difícil");
        }
        div.textContent = idx + 1;
        div.onclick = () => {
          autoMarkDifficulty();
          currentQuestionIndex = idx;
          displayQuestion();
        };
        progressBar.appendChild(div);
      });
    }
    /* MOSTRAR PREGUNTA ACTUAL */
    function displayQuestion() {
      if(deck.length === 0) return;
      const q = deck[currentQuestionIndex];
      const cardContent = document.getElementById("cardContent");
      const optionsContainer = document.getElementById("optionsContainer");
      const cardAnswer = document.getElementById("cardAnswer");
      const cardExplanation = document.getElementById("cardExplanation");
      // Reinicia estado de flip
      document.getElementById("card").classList.remove("flip");
      cardContent.innerHTML = "";
      optionsContainer.innerHTML = "";
      cardAnswer.innerHTML = "";
      cardExplanation.innerHTML = "";
      // Cara 1: Mostrar la Pregunta
      cardContent.textContent = q.Pregunta;
      // Si es tipo Test, mostrar opciones aleatorias y corrección inmediata
      if(q["Test o Flashcard"].toLowerCase() === "test") {
        let opts = q.Respuesta.split("/");
        opts = opts.map(o => o.trim());
        opts = shuffleArray(opts);
        opts.forEach(opt => {
          const div = document.createElement("div");
          div.className = "option";
          div.textContent = opt;
          div.onclick = () => {
            const correct = (opt === q.Respuesta.split("/")[0].trim());
            if(correct) div.classList.add("correct");
            else div.classList.add("incorrect");
            // Desactivar más clics
            Array.from(optionsContainer.children).forEach(child => child.onclick = null);
          };
          optionsContainer.appendChild(div);
        });
      }
      // Cara 2 y 3: Respuesta y Explicación
      cardAnswer.textContent = "Respuesta: " + q.Respuesta.split("/")[0].trim();
      cardExplanation.textContent = "Explicación: " + q.Explicación;
      renderProgressBar();
    }
    /* UTILIDADES */
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    /* CONTROLES DE LA TARJETA */
    function flipCard() {
      document.getElementById("card").classList.toggle("flip");
    }
    function nextQuestion() {
      autoMarkDifficulty();
      if(currentQuestionIndex < deck.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
      }
    }
    function prevQuestion() {
      autoMarkDifficulty();
      if(currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
    }
    // Si la pregunta actual no tiene dificultad asignada, se marca automáticamente como "fácil"
    function autoMarkDifficulty() {
      const currentQ = deck[currentQuestionIndex];
      if(!currentQ.dificultad || currentQ.dificultad.trim() === "") {
        setDifficulty("fácil", true);
      }
    }
    // Establece la dificultad y actualiza el backend
    function setDifficulty(level, auto=false) {
      const currentQ = deck[currentQuestionIndex];
      currentQ.dificultad = level;
      renderProgressBar();
      const payload = {
        action: "updateDifficulty",
        category: currentQ.Categoría,
        subject: currentQ.Asignatura,
        topic: currentQ.Tema,
        id: currentQ["id#"],
        dificultad: level
      };
      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(() => {
        if(!auto) alert("Dificultad actualizada a " + level);
      }).catch(err => console.error(err));
    }
    /* CAMBIO DE MODO */
    function toggleDarkMode() {
      darkMode = !darkMode;
      document.body.className = darkMode ? "dark" : "light";
    }
    /* SALIR DEL MODO DE ESTUDIO */
    function exitStudy() {
      document.getElementById("studyView").classList.remove("active");
      showFolderView();
    }
    /* NAVEGACIÓN CON TECLADO */
    document.addEventListener("keydown", (e) => {
      if(document.getElementById("studyView").classList.contains("active")) {
        if(e.key === "ArrowRight") nextQuestion();
        if(e.key === "ArrowLeft") prevQuestion();
        if(e.key === "ArrowUp" || e.key === " ") flipCard();
      }
    });
    /* INICIO: Cargar estructura al acceder a la página */
    window.onload = function() {
      loadFolderStructure();
    };
  </script>
</body>
</html>
