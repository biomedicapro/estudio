<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Módulo de Estudio Interactivo</title>
  <style>
    /* Reset y base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }
    body { font-family: "Segoe UI", sans-serif; background-color: #fefefe; color: #111; overflow: hidden; }
    
    /* Transiciones y animaciones */
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .flip { transition: transform 0.6s; transform-style: preserve-3d; }
    .flipped { transform: rotateY(180deg); }

    /* Vistas de selección (carpetas) */
    .view { display: none; width: 100%; height: 100%; padding: 20px; overflow-y: auto; }
    .view.active { display: block; }
    .folder-list { list-style: none; margin: 10px 0; }
    .folder-item {
      padding: 15px; margin: 8px 0; border: 1px solid #aaa;
      border-radius: 6px; background-color: #eaeaea; cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    .folder-item:hover { background-color: #ddd; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
    .back-btn { margin-bottom: 15px; padding: 10px 15px; background-color: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    
    /* Estilos para la interfaz de estudio en pantalla completa */
    #studyInterface { display: none; width: 100%; height: 100%; position: relative; background-color: #fff; }
    #studyInterface.dark { background-color: #222; color: #eee; }
    
    /* Panel superior – Barra de progreso */
    #progressPanel {
      position: absolute; top: 0; left: 0; right: 0; height: 60px;
      background-color: rgba(0,0,0,0.05); display: flex; align-items: center; padding: 0 10px;
      overflow-x: auto;
    }
    .progress-item {
      width: 40px; height: 40px; line-height: 40px; text-align: center;
      margin: 0 5px; border-radius: 50%; background-color: #bbb;
      flex-shrink: 0; font-weight: bold;
    }
    /* Colores según dificultad */
    .diff-facil { background-color: #4caf50; }
    .diff-medio { background-color: #ffeb3b; color: #333; }
    .diff-dificil { background-color: #f44336; }
    
    /* Panel derecho – Controles interactivos */
    #controlPanel {
      position: absolute; top: 60px; right: 0; bottom: 0; width: 70px;
      background-color: rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center;
      padding: 10px; gap: 15px;
    }
    #controlPanel button {
      width: 50px; height: 50px; border: none; border-radius: 50%;
      background-color: #333; color: #fff; font-size: 18px; cursor: pointer;
      transition: background-color 0.2s;
    }
    #controlPanel button:hover { background-color: #555; }
    
    /* Área central – Tarjeta de estudio */
    #cardContainer {
      position: absolute; top: 60px; left: 0; right: 70px; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      perspective: 1000px;
    }
    .card {
      width: 90%; max-width: 600px; min-height: 300px; background-color: #fff;
      border-radius: 10px; padding: 20px; position: relative;
      text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transform-style: preserve-3d;
    }
    #studyInterface.dark .card { background-color: #333; color: #eee; }
    .card-face {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center; padding: 20px;
      font-size: calc(16px + 0.5vw); word-wrap: break-word;
    }
    .face-back { transform: rotateY(180deg); }
    
    /* Flechas de navegación para cambiar de pregunta o flip */
    .nav-arrow {
      position: absolute; bottom: 20px; width: 50px; height: 50px;
      background-color: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 50%;
      font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: background-color 0.2s;
    }
    .nav-arrow:hover { background-color: rgba(0,0,0,0.7); }
    #prevQuestion { left: 20px; }
    #nextQuestion { right: 20px; }
    #flipCard { bottom: 90px; left: calc(50% - 25px); }
    
    /* Botón para salir de estudio */
    #exitStudy {
      position: absolute; top: 10px; left: 10px; padding: 10px 15px;
      background-color: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Vistas de selección de mazo -->
  <div id="selectView" class="view active fade-in">
    <h2>Seleccione una Categoría</h2>
    <ul id="catList" class="folder-list"></ul>
  </div>
  <div id="subjectView" class="view fade-in">
    <button class="back-btn" onclick="goBack('selectView')">&larr; Categorías</button>
    <h2>Seleccione una Asignatura</h2>
    <ul id="subjList" class="folder-list"></ul>
  </div>
  <div id="topicView" class="view fade-in">
    <button class="back-btn" onclick="goBack('subjectView')">&larr; Asignaturas</button>
    <h2>Seleccione un Tema</h2>
    <ul id="topicList" class="folder-list"></ul>
  </div>

  <!-- Interfaz de estudio (pantalla completa) -->
  <div id="studyInterface">
    <!-- Panel superior – Barra de progreso -->
    <div id="progressPanel"></div>
    <!-- Panel derecho – Controles interactivos -->
    <div id="controlPanel">
      <button id="btnBack" title="Regresar">&#x21a9;</button>
      <button id="btnToggleMode" title="Modo Claro/Oscuro">&#9788;</button>
      <button class="diff-btn" data-diff="Fácil" title="Fácil">1</button>
      <button class="diff-btn" data-diff="Medio" title="Medio">2</button>
      <button class="diff-btn" data-diff="Difícil" title="Difícil">3</button>
    </div>
    <!-- Área central – Tarjeta -->
    <div id="cardContainer">
      <div id="card" class="card flip">
        <!-- Cara 1: Pregunta -->
        <div class="card-face face-front" id="cardFront"></div>
        <!-- Cara 2: Respuesta (se usa para ambas funciones) -->
        <div class="card-face face-back" id="cardBack"></div>
      </div>
    </div>
    <!-- Flechas de navegación -->
    <button id="prevQuestion" class="nav-arrow" title="Pregunta anterior">&#9664;</button>
    <button id="flipCard" class="nav-arrow" title="Ver respuesta">&#8635;</button>
    <button id="nextQuestion" class="nav-arrow" title="Siguiente pregunta">&#9654;</button>
    <!-- Botón de salida -->
    <button id="exitStudy" onclick="exitStudy()">Salir</button>
  </div>

  <script>
    /* ===============================
       Variables globales y estado
    ================================ */
    // URL de despliegue del Apps Script (reemplazar YOUR_SCRIPT_ID)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyelDks7HNa6ov41RZ30ATatXyymU0pNpdh2MDHXC7Pk-ahuRIdRLj-1EVXvDLIHzMb/exec';

    let folderData = null;     // Estructura de carpetas: Categorías > Asignaturas > Temas
    let questions = [];        // Lista de preguntas para el tema seleccionado
    let currentIndex = 0;      // Índice de la pregunta actual
    let currentFace = 0;       // 0: Pregunta, 1: Respuesta, 2: (opcional) Podríamos ampliar a explicación si se desea
    let studyMode = "light";   // Modo claro u oscuro

    /* ===============================
       Funciones de carga y navegación
    ================================ */
    // Cargar la estructura de carpetas desde el Sheet (GET action=getFolders)
    function loadFolders() {
      fetch(SCRIPT_URL + '?action=getFolders')
      .then(response => response.json())
      .then(data => {
        if(data.status === "success") {
          folderData = data.folders;
          renderCategories();
        } else {
          alert("Error cargando carpetas: " + data.message);
        }
      })
      .catch(err => console.error(err));
    }

    // Renderizar Categorías en selectView
    function renderCategories() {
      const catList = document.getElementById("catList");
      catList.innerHTML = "";
      folderData.forEach(cat => {
        const li = document.createElement("li");
        li.className = "folder-item";
        li.textContent = cat.name;
        li.onclick = () => {
          sessionStorage.setItem("selectedCategory", cat.name);
          renderSubjects(cat);
          showView("subjectView");
        };
        catList.appendChild(li);
      });
    }
    // Renderizar Asignaturas
    function renderSubjects(category) {
      const subjList = document.getElementById("subjList");
      subjList.innerHTML = "";
      Object.keys(category).forEach(key => {
        if(key !== "name") { } // no-op
      });
      // Cada elemento de folderData es {name: "Categoría", subjects: [...]}
      // Buscar la categoría seleccionada
      const selected = folderData.find(c => c.name === category.name);
      selected.subjects.forEach(subj => {
        const li = document.createElement("li");
        li.className = "folder-item";
        li.textContent = subj.name;
        li.onclick = () => {
          sessionStorage.setItem("selectedSubject", subj.name);
          renderTopics(selected, subj);
          showView("topicView");
        };
        subjList.appendChild(li);
      });
    }
    // Renderizar Temas
    function renderTopics(category, subject) {
      const topicList = document.getElementById("topicList");
      topicList.innerHTML = "";
      subject.topics.forEach(topic => {
        const li = document.createElement("li");
        li.className = "folder-item";
        li.textContent = topic;
        li.onclick = () => {
          sessionStorage.setItem("selectedTopic", topic);
          // Cargar el mazo de preguntas para la combinación seleccionada
          loadQuestions(sessionStorage.getItem("selectedCategory"), sessionStorage.getItem("selectedSubject"), topic);
        };
        topicList.appendChild(li);
      });
    }
    // Función para mostrar una vista específica
    function showView(viewId) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById(viewId).classList.add("active");
    }
    // Volver a la vista anterior
    function goBack(viewId) { showView(viewId); }

    /* ===============================
       Funciones para cargar y procesar preguntas
    ================================ */
    // Cargar preguntas para la combinación: categoría, asignatura, tema
    function loadQuestions(category, subject, topic) {
      fetch(`${SCRIPT_URL}?action=getQuestions&category=${encodeURIComponent(category)}&subject=${encodeURIComponent(subject)}&topic=${encodeURIComponent(topic)}`)
      .then(response => response.json())
      .then(data => {
        if(data.status === "success") {
          questions = data.questions;
          // Buscar la primera pregunta sin dificultad (para retomar estudio)
          const idx = questions.findIndex(q => !q.difficulty || q.difficulty === "");
          currentIndex = (idx >= 0) ? idx : 0;
          currentFace = 0;
          renderProgressPanel();
          renderCard();
          showStudyInterface();
        } else {
          alert("Error cargando preguntas: " + data.message);
        }
      })
      .catch(err => console.error(err));
    }
    // Mostrar la interfaz de estudio y solicitar pantalla completa
    function showStudyInterface() {
      showView(""); // Ocultar las vistas de selección
      document.getElementById("studyInterface").style.display = "block";
      // Intentar activar pantalla completa (F11 manualmente en la mayoría de navegadores)
    }

    /* ===============================
       Renderización de la interfaz de estudio
    ================================ */
    // Renderizar el panel superior (progreso)
    function renderProgressPanel() {
      const panel = document.getElementById("progressPanel");
      panel.innerHTML = "";
      questions.forEach((q, index) => {
        const div = document.createElement("div");
        div.className = "progress-item";
        div.textContent = q.id;
        if(q.difficulty) {
          if(q.difficulty === "Fácil") div.classList.add("diff-facil");
          else if(q.difficulty === "Medio") div.classList.add("diff-medio");
          else if(q.difficulty === "Difícil") div.classList.add("diff-dificil");
        }
        panel.appendChild(div);
      });
    }
    // Renderizar la tarjeta (pregunta/respuesta)
    function renderCard() {
      if(questions.length === 0) return;
      const q = questions[currentIndex];
      const cardFront = document.getElementById("cardFront");
      const cardBack = document.getElementById("cardBack");
      // Si la pregunta es tipo test, se deben mostrar las opciones en orden aleatorio en la cara de pregunta
      if(q.type.toLowerCase() === "test") {
        // Suponemos que en q.answer se encuentran las opciones separadas por "/" y la respuesta correcta es la primera
        let options = q.answer.split("/").map(o => o.trim());
        // Mezclar las opciones
        options.sort(() => Math.random() - 0.5);
        cardFront.innerHTML = `<div><strong>${q.question}</strong></div><br>`;
        options.forEach(opt => {
          const btn = document.createElement("button");
          btn.style.margin = "5px";
          btn.style.padding = "10px";
          btn.style.borderRadius = "4px";
          btn.style.border = "1px solid #333";
          btn.textContent = opt;
          btn.onclick = () => {
            if(opt === q.answer.split("/")[0].trim()) {
              btn.style.backgroundColor = "#4caf50";
            } else {
              btn.style.backgroundColor = "#f44336";
            }
          };
          cardFront.appendChild(btn);
        });
      } else {
        // Para flashcard, solo se muestra la pregunta
        cardFront.innerHTML = `<div><strong>${q.question}</strong></div>`;
      }
      // Cara de respuesta: mostrar la respuesta correcta y la explicación
      cardBack.innerHTML = `<div><strong>Respuesta:</strong> ${q.answer}</div><br><div><strong>Explicación:</strong> ${q.explanation}</div>`;
      // Reiniciar la tarjeta sin flip (mostrar cara frontal)
      const card = document.getElementById("card");
      card.classList.remove("flipped");
      currentFace = 0;
    }

    /* ===============================
       Navegación entre preguntas y caras
    ================================ */
    function nextQuestion() {
      // Si la pregunta actual no tiene dificultad asignada, actualizarla automáticamente como "Fácil"
      if(!questions[currentIndex].difficulty || questions[currentIndex].difficulty === "") {
        updateDifficulty(questions[currentIndex], "Fácil");
      }
      if(currentIndex < questions.length - 1) {
        currentIndex++;
        currentFace = 0;
        renderCard();
      }
      renderProgressPanel();
    }
    function prevQuestion() {
      if(currentIndex > 0) {
        currentIndex--;
        currentFace = 0;
        renderCard();
      }
    }
    // Alternar (flip) la tarjeta para ver la respuesta
    function flipCard() {
      const card = document.getElementById("card");
      card.classList.toggle("flipped");
      currentFace = (currentFace === 0) ? 1 : 0;
    }
    // Actualizar la dificultad de la pregunta actual vía Apps Script
    function updateDifficulty(question, difficulty) {
      // Actualizamos localmente
      question.difficulty = difficulty;
      renderProgressPanel();
      // Enviar POST al backend para actualizar el Sheet
      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          updateDifficulty: true,
          category: question.category,
          subject: question.subject,
          topic: question.topic,
          id: question.id,
          difficulty: difficulty
        })
      });
    }

    /* ===============================
       Control de botones y eventos
    ================================ */
    document.getElementById("nextQuestion").addEventListener("click", nextQuestion);
    document.getElementById("prevQuestion").addEventListener("click", prevQuestion);
    document.getElementById("flipCard").addEventListener("click", flipCard);
    // Botón de regresar: vuelve a la selección de tema y oculta la interfaz de estudio
    document.getElementById("btnBack").addEventListener("click", () => {
      document.getElementById("studyInterface").style.display = "none";
      showView("topicView");
    });
    // Botón para alternar modo claro/oscuro
    document.getElementById("btnToggleMode").addEventListener("click", () => {
      const studyInt = document.getElementById("studyInterface");
      if(studyInt.classList.contains("dark")) {
        studyInt.classList.remove("dark");
        studyMode = "light";
        document.getElementById("btnToggleMode").innerHTML = "&#9788;";
      } else {
        studyInt.classList.add("dark");
        studyMode = "dark";
        document.getElementById("btnToggleMode").innerHTML = "&#9790;";
      }
    });
    // Botones de dificultad
    document.querySelectorAll(".diff-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const diff = btn.getAttribute("data-diff");
        updateDifficulty(questions[currentIndex], diff);
        // Avanzar a la siguiente pregunta tras marcar
        nextQuestion();
      });
    });
    // Atajos de teclado para navegación (flechas izquierda/derecha para cambiar pregunta; espacio para flip)
    document.addEventListener("keydown", (e) => {
      if(document.getElementById("studyInterface").style.display === "block") {
        if(e.key === "ArrowRight") nextQuestion();
        if(e.key === "ArrowLeft") prevQuestion();
        if(e.key === " ") { e.preventDefault(); flipCard(); }
      }
    });
    // Función para salir de la interfaz de estudio y volver a la selección
    function exitStudy() {
      document.getElementById("studyInterface").style.display = "none";
      showView("topicView");
    }

    /* ===============================
       Inicialización
    ================================ */
    window.onload = () => {
      loadFolders();
    };
  </script>
</body>
</html>
